<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>命名空间管理 - Rustacos</title>
    <link rel="stylesheet" href="bootstrap.min.css">
    <style>
        /* 直接内联字体定义 */
        @font-face {
            font-display: block;
            font-family: "bootstrap-icons";
            src: url("/fonts/bootstrap-icons.woff2?2ab2cbbe07fcebb53bdaa7313bb290f2") format("woff2"),
                 url("/fonts/bootstrap-icons.woff?2ab2cbbe07fcebb53bdaa7313bb290f2") format("woff");
        }
        
        .bi::before,
        [class^="bi-"]::before,
        [class*=" bi-"]::before {
            display: inline-block;
            font-family: bootstrap-icons !important;
            font-style: normal;
            font-weight: normal !important;
            font-variant: normal;
            text-transform: none;
            line-height: 1;
            vertical-align: -.125em;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .bi-eye::before { content: "\f341"; }
        .bi-pencil::before { content: "\f4cb"; }
        .bi-trash::before { content: "\f5de"; }
        .bi-plus-circle::before { content: "\f4fa"; }
        .bi-server::before { content: "\f4a3"; }
        .bi-gear::before { content: "\f3e5"; }
        .bi-folder::before { content: "\f3b1"; }
        .bi-hdd-network::before { content: "\f4b6"; }
        .bi-speedometer2::before { content: "\f549"; }
        .bi-plus-lg::before { content: "\f2bb"; }
        .bi-x-lg::before { content: "\f659"; }
        
        /* 确保图标正确显示 */
        .btn i.bi {
            font-size: 1em;
            line-height: 1;
        }
        
        /* 确保按钮有合适的内边距 */
        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
        }
        
        /* 确保图标在按钮中垂直居中 */
        .btn i {
            vertical-align: middle;
        }
        
        /* 页面布局 - 确保页脚固定在底部 */
        html, body {
            height: 100%;
        }
        
        body {
            display: flex;
            flex-direction: column;
        }
        
        .content-wrapper {
            flex: 1 0 auto;
        }
        
        footer {
            flex-shrink: 0;
        }
        
        /* 页面标题样式 */
        .page-title {
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 1rem;
            margin-bottom: 2rem;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="bi bi-hdd-network"></i> Rustacos
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">
                            <i class="bi bi-speedometer2"></i> 仪表盘
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/services.html">
                            <i class="bi bi-server"></i> 服务管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/configs.html">
                            <i class="bi bi-gear"></i> 配置管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/namespaces.html">
                            <i class="bi bi-folder"></i> 命名空间
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="content-wrapper">
        <div class="container mt-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="page-title mb-0">
                    <i class="bi bi-folder"></i> 命名空间管理
                </h2>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createNamespaceModal">
                    <i class="bi bi-plus-lg"></i> 创建命名空间
                </button>
            </div>
            
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="namespacesTable">
                            <thead>
                                <tr>
                                    <th>命名空间</th>
                                    <th>显示名称</th>
                                    <th>描述</th>
                                    <th>配额</th>
                                    <th>创建时间</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="6" class="text-center">
                                        <div class="spinner-border" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 创建命名空间模态框 -->
    <div class="modal fade" id="createNamespaceModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">创建命名空间</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createNamespaceForm">
                        <div class="mb-3">
                            <label for="namespace" class="form-label">命名空间ID <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="namespace" required 
                                   pattern="[a-zA-Z0-9_-]+" placeholder="例如: test, dev, prod">
                            <div class="form-text">只能包含字母、数字、下划线和连字符</div>
                        </div>
                        <div class="mb-3">
                            <label for="namespaceShowName" class="form-label">显示名称 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="namespaceShowName" required 
                                   placeholder="例如: 测试环境、开发环境">
                        </div>
                        <div class="mb-3">
                            <label for="namespaceDesc" class="form-label">描述</label>
                            <textarea class="form-control" id="namespaceDesc" rows="3" 
                                      placeholder="命名空间描述信息"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="createNamespace()">创建</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑命名空间模态框 -->
    <div class="modal fade" id="editNamespaceModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">编辑命名空间</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editNamespaceForm">
                        <input type="hidden" id="editOriginalNamespace">
                        <div class="mb-3">
                            <label for="editNamespaceShowName" class="form-label">显示名称 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editNamespaceShowName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editNamespaceDesc" class="form-label">描述</label>
                            <textarea class="form-control" id="editNamespaceDesc" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="editNamespaceQuota" class="form-label">配额</label>
                            <input type="number" class="form-control" id="editNamespaceQuota" min="1" max="1000">
                            <div class="form-text">配置项数量限制（1-1000）</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="updateNamespace()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-dark text-white text-center py-3">
        <div class="container">
            <p class="mb-0">© 2024 Rustacos - Nacos的Rust实现</p>
            <small class="text-muted">使用原生JavaScript构建的现代Web界面</small>
        </div>
    </footer>

    <script src="bootstrap.bundle.min.js"></script>
    <script>
        // 加载命名空间数据
        async function loadNamespaces() {
            try {
                const response = await fetch('/nacos/v1/console/namespaces');
                const result = await response.json();
                
                const tbody = document.querySelector('#namespacesTable tbody');
                tbody.innerHTML = '';
                
                if (result.code === 200 && result.data) {
                    if (result.data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" class="text-center">暂无命名空间</td></tr>';
                        return;
                    }
                    
                    result.data.forEach(ns => {
                        const tr = document.createElement('tr');
                        const createTime = new Date(ns.create_time * 1000).toLocaleString();
                        
                        tr.innerHTML = `
                            <td><code>${ns.namespace}</code></td>
                            <td>${ns.namespace_show_name}</td>
                            <td>${ns.namespace_desc || '-'}</td>
                            <td>${ns.quota}</td>
                            <td>${createTime}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary me-1" onclick="editNamespaceModal('${ns.namespace}', '${ns.namespace_show_name}', '${ns.namespace_desc || ''}', ${ns.quota})" title="编辑">
                                    <i class="bi bi-pencil"></i> 编辑
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteNamespace('${ns.namespace}')" title="删除" 
                                        ${ns.namespace === 'public' ? 'disabled' : ''}>
                                    <i class="bi bi-trash"></i> 删除
                                </button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center">加载失败</td></tr>';
                }
            } catch (error) {
                console.error('Error loading namespaces:', error);
                const tbody = document.querySelector('#namespacesTable tbody');
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">加载失败</td></tr>';
            }
        }
        
        // 创建命名空间
        async function createNamespace() {
            const namespace = document.getElementById('namespace').value.trim();
            const namespaceShowName = document.getElementById('namespaceShowName').value.trim();
            const namespaceDesc = document.getElementById('namespaceDesc').value.trim();
            
            if (!namespace || !namespaceShowName) {
                alert('请填写必填字段');
                return;
            }
            
            try {
                const response = await fetch('/nacos/v1/console/namespaces', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        namespace: namespace,
                        namespace_show_name: namespaceShowName,
                        namespace_desc: namespaceDesc
                    })
                });
                
                const result = await response.json();
                
                if (result.code === 200 && result.data) {
                    // 关闭模态框
                    const modal = bootstrap.Modal.getInstance(document.getElementById('createNamespaceModal'));
                    modal.hide();
                    
                    // 清空表单
                    document.getElementById('createNamespaceForm').reset();
                    
                    // 重新加载数据
                    loadNamespaces();
                    
                    alert('命名空间创建成功');
                } else {
                    alert('创建失败: ' + result.message);
                }
            } catch (error) {
                console.error('Error creating namespace:', error);
                alert('创建失败: 网络错误');
            }
        }
        
        // 打开编辑模态框
        function editNamespaceModal(namespace, showName, desc, quota) {
            document.getElementById('editOriginalNamespace').value = namespace;
            document.getElementById('editNamespaceShowName').value = showName;
            document.getElementById('editNamespaceDesc').value = desc;
            document.getElementById('editNamespaceQuota').value = quota;
            
            const modal = new bootstrap.Modal(document.getElementById('editNamespaceModal'));
            modal.show();
        }
        
        // 更新命名空间
        async function updateNamespace() {
            const namespace = document.getElementById('editOriginalNamespace').value;
            const namespaceShowName = document.getElementById('editNamespaceShowName').value.trim();
            const namespaceDesc = document.getElementById('editNamespaceDesc').value.trim();
            const namespaceQuota = parseInt(document.getElementById('editNamespaceQuota').value);
            
            if (!namespaceShowName) {
                alert('请填写显示名称');
                return;
            }
            
            try {
                const response = await fetch(`/nacos/v1/console/namespaces/${namespace}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        namespace_show_name: namespaceShowName,
                        namespace_desc: namespaceDesc,
                        quota: namespaceQuota
                    })
                });
                
                const result = await response.json();
                
                if (result.code === 200 && result.data) {
                    // 关闭模态框
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editNamespaceModal'));
                    modal.hide();
                    
                    // 重新加载数据
                    loadNamespaces();
                    
                    alert('命名空间更新成功');
                } else {
                    alert('更新失败: ' + result.message);
                }
            } catch (error) {
                console.error('Error updating namespace:', error);
                alert('更新失败: 网络错误');
            }
        }
        
        // 删除命名空间
        async function deleteNamespace(namespace) {
            if (namespace === 'public') {
                alert('不能删除默认命名空间');
                return;
            }
            
            if (!confirm(`确定要删除命名空间 "${namespace}" 吗？\n\n删除后，该命名空间下的所有配置也将被删除！`)) {
                return;
            }
            
            try {
                const response = await fetch(`/nacos/v1/console/namespaces/${namespace}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.code === 200 && result.data) {
                    // 重新加载数据
                    loadNamespaces();
                    
                    alert('命名空间删除成功');
                } else {
                    alert('删除失败: ' + result.message);
                }
            } catch (error) {
                console.error('Error deleting namespace:', error);
                alert('删除失败: 网络错误');
            }
        }
        
        // 页面加载时加载数据
        document.addEventListener('DOMContentLoaded', loadNamespaces);
    </script>
</body>
</html>