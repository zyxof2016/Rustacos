<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rustacos - Nacos的Rust实现</title>
    <link rel="stylesheet" href="bootstrap.min.css">
    <style>
        /* 直接内联字体定义 */
        @font-face {
            font-display: block;
            font-family: "bootstrap-icons";
            src: url("/fonts/bootstrap-icons.woff2?2ab2cbbe07fcebb53bdaa7313bb290f2") format("woff2"),
                 url("/fonts/bootstrap-icons.woff?2ab2cbbe07fcebb53bdaa7313bb290f2") format("woff");
        }
        
        .bi::before,
        [class^="bi-"]::before,
        [class*=" bi-"]::before {
            display: inline-block;
            font-family: bootstrap-icons !important;
            font-style: normal;
            font-weight: normal !important;
            font-variant: normal;
            text-transform: none;
            line-height: 1;
            vertical-align: -.125em;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .bi-eye::before { content: "\f341"; }
        .bi-pencil::before { content: "\f4cb"; }
        .bi-trash::before { content: "\f5de"; }
        .bi-plus-circle::before { content: "\f4fa"; }
        .bi-server::before { content: "\f4a3"; }
        .bi-gear::before { content: "\f3e5"; }
        .bi-folder::before { content: "\f3b1"; }
        .bi-hdd-network::before { content: "\f4b6"; }
        .bi-speedometer2::before { content: "\f549"; }
        .bi-plus-lg::before { content: "\f2bb"; }
        .bi-x-lg::before { content: "\f659"; }
        .bi-heart-pulse::before { content: "\f21f"; }
        .bi-heart-pulse-fill::before { content: "\f21e"; }
        .bi-activity::before { content: "\f541"; }
        .bi-graph-up::before { content: "\f3a9"; }
        .bi-database::before { content: "\f1ca"; }
        .bi-clock-history::before { content: "\f55d"; }
        .bi-check-circle::before { content: "\f268"; }
        .bi-exclamation-triangle::before { content: "\f33a"; }
        
        /* 确保图标正确显示 */
        .btn i.bi {
            font-size: 1em;
            line-height: 1;
        }
        
        /* 确保按钮有合适的内边距 */
        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
        }
        
        /* 确保图标在按钮中垂直居中 */
        .btn i {
            vertical-align: middle;
        }
        
        /* 页面布局 - 确保页脚固定在底部 */
        html, body {
            height: 100%;
        }
        
        body {
            display: flex;
            flex-direction: column;
        }
        
        .content-wrapper {
            flex: 1 0 auto;
        }
        
        footer {
            flex-shrink: 0;
        }
        
        /* 页面标题样式 */
        .page-title {
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 1rem;
            margin-bottom: 2rem;
        }
        
        /* 统计卡片样式 */
        .stats-card {
            transition: transform 0.2s;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stats-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .stats-card .card-body {
            padding: 1.5rem;
        }
        
        .stats-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .stats-icon.primary {
            background-color: rgba(13, 110, 253, 0.1);
            color: #0d6efd;
        }
        
        .stats-icon.success {
            background-color: rgba(25, 135, 84, 0.1);
            color: #198754;
        }
        
        .stats-icon.info {
            background-color: rgba(13, 202, 240, 0.1);
            color: #0dcaf0;
        }
        
        .stats-icon.warning {
            background-color: rgba(255, 193, 7, 0.1);
            color: #ffc107;
        }
        
        /* 系统状态卡片 */
        .status-card {
            border-left: 4px solid;
            transition: all 0.2s;
        }
        
        .status-card:hover {
            transform: translateX(5px);
        }
        
        .status-card.healthy {
            border-left-color: #198754;
        }
        
        .status-card.warning {
            border-left-color: #ffc107;
        }
        
        /* 最近活动列表 */
        .activity-item {
            padding: 0.75rem 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .activity-item:last-child {
            border-bottom: none;
        }
        
        .activity-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        
        /* 快捷操作按钮 */
        .quick-action {
            text-decoration: none;
            color: inherit;
            display: block;
            padding: 1rem;
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .quick-action:hover {
            background-color: #f8f9fa;
            transform: translateY(-2px);
        }
        
        /* 加载动画 */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #0d6efd;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="bi bi-hdd-network"></i> Rustacos
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="/">
                            <i class="bi bi-speedometer2"></i> 仪表盘
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/services.html">
                            <i class="bi bi-server"></i> 服务管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/configs.html">
                            <i class="bi bi-gear"></i> 配置管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/namespaces.html">
                            <i class="bi bi-folder"></i> 命名空间
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="content-wrapper">
        <div class="container mt-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="page-title mb-0">
                    <i class="bi bi-speedometer2"></i> 系统仪表盘
                </h2>
                <div class="d-flex align-items-center">
                    <span class="text-muted me-3" id="lastUpdateTime">最后更新: --</span>
                    <button class="btn btn-outline-secondary btn-sm" onclick="refreshDashboard()">
                        <i class="bi bi-arrow-clockwise"></i> 刷新
                    </button>
                </div>
            </div>
            
            <!-- 统计卡片 -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card stats-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-subtitle mb-2 text-muted">服务总数</h6>
                                    <h3 class="card-title mb-0" id="totalServices">
                                        <div class="loading-spinner"></div>
                                    </h3>
                                </div>
                                <div class="stats-icon primary">
                                    <i class="bi bi-server"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stats-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-subtitle mb-2 text-muted">实例总数</h6>
                                    <h3 class="card-title mb-0" id="totalInstances">
                                        <div class="loading-spinner"></div>
                                    </h3>
                                </div>
                                <div class="stats-icon success">
                                    <i class="bi bi-heart-pulse"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stats-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-subtitle mb-2 text-muted">配置总数</h6>
                                    <h3 class="card-title mb-0" id="totalConfigs">
                                        <div class="loading-spinner"></div>
                                    </h3>
                                </div>
                                <div class="stats-icon info">
                                    <i class="bi bi-gear"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stats-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-subtitle mb-2 text-muted">命名空间总数</h6>
                                    <h3 class="card-title mb-0" id="totalNamespaces">
                                        <div class="loading-spinner"></div>
                                    </h3>
                                </div>
                                <div class="stats-icon warning">
                                    <i class="bi bi-folder"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <!-- 系统状态 -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">系统状态</h5>
                            <span class="badge bg-success" id="systemStatus">
                                <i class="bi bi-check-circle"></i> 运行中
                            </span>
                        </div>
                        <div class="card-body">
                            <div class="status-card healthy mb-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">服务器状态</h6>
                                        <small class="text-muted">后端服务运行状态</small>
                                    </div>
                                    <span class="badge bg-success rounded-pill">
                                        <i class="bi bi-activity"></i> 正常
                                    </span>
                                </div>
                            </div>
                            <div class="status-card healthy mb-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">数据存储</h6>
                                        <small class="text-muted">配置数据存储方式</small>
                                    </div>
                                    <span class="badge bg-primary rounded-pill">
                                        <i class="bi bi-database"></i> 内存
                                    </span>
                                </div>
                            </div>
                            <div class="status-card healthy">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">API服务</h6>
                                        <small class="text-muted">RESTful API可用性</small>
                                    </div>
                                    <span class="badge bg-success rounded-pill">
                                        <i class="bi bi-gear"></i> 可用
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 快捷操作 -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">快捷操作</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-6">
                                    <a href="/services.html" class="quick-action">
                                        <div class="d-flex align-items-center">
                                            <div class="stats-icon primary me-3">
                                                <i class="bi bi-plus-lg"></i>
                                            </div>
                                            <div>
                                                <h6 class="mb-0">注册服务</h6>
                                                <small class="text-muted">添加新服务实例</small>
                                            </div>
                                        </div>
                                    </a>
                                </div>
                                <div class="col-6">
                                    <a href="/configs.html" class="quick-action">
                                        <div class="d-flex align-items-center">
                                            <div class="stats-icon info me-3">
                                                <i class="bi bi-plus-lg"></i>
                                            </div>
                                            <div>
                                                <h6 class="mb-0">添加配置</h6>
                                                <small class="text-muted">创建新配置项</small>
                                            </div>
                                        </div>
                                    </a>
                                </div>
                                <div class="col-6">
                                    <a href="/namespaces.html" class="quick-action">
                                        <div class="d-flex align-items-center">
                                            <div class="stats-icon warning me-3">
                                                <i class="bi bi-folder"></i>
                                            </div>
                                            <div>
                                                <h6 class="mb-0">命名空间</h6>
                                                <small class="text-muted">管理命名空间</small>
                                            </div>
                                        </div>
                                    </a>
                                </div>
                                <div class="col-6">
                                    <a href="/services.html" class="quick-action">
                                        <div class="d-flex align-items-center">
                                            <div class="stats-icon success me-3">
                                                <i class="bi bi-server"></i>
                                            </div>
                                            <div>
                                                <h6 class="mb-0">服务列表</h6>
                                                <small class="text-muted">查看所有服务</small>
                                            </div>
                                        </div>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 最近活动和系统信息 -->
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">最近服务</h5>
                        </div>
                        <div class="card-body">
                            <div id="recentServices">
                                <div class="text-center text-muted p-3">
                                    <div class="loading-spinner"></div>
                                    <p class="mt-2 mb-0">加载中...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">系统信息</h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-borderless table-sm">
                                <tr>
                                    <td><strong>版本:</strong></td>
                                    <td>Rustacos v0.1.0</td>
                                </tr>
                                <tr>
                                    <td><strong>构建时间:</strong></td>
                                    <td id="buildTime">--</td>
                                </tr>
                                <tr>
                                    <td><strong>运行时间:</strong></td>
                                    <td id="uptime">--</td>
                                </tr>
                                <tr>
                                    <td><strong>监听端口:</strong></td>
                                    <td>8848</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-dark text-white text-center py-3">
        <div class="container">
            <p class="mb-0">© 2024 Rustacos - Nacos的Rust实现</p>
            <small class="text-muted">使用原生JavaScript构建的现代Web界面</small>
        </div>
    </footer>

    <script src="bootstrap.bundle.min.js"></script>
    <script>
        let startTime = Date.now();
        
        // 加载仪表盘数据
        async function loadDashboardData() {
            try {
                // 并行加载所有数据
                const [servicesResponse, instancesResponse, namespacesResponse] = await Promise.all([
                    fetch('/nacos/v1/ns/service/list'),
                    fetch('/nacos/v1/ns/instance/list'),
                    fetch('/nacos/v1/console/namespaces')
                ]);
                
                const services = await servicesResponse.json();
                const instances = await instancesResponse.json();
                const namespaces = await namespacesResponse.json();
                
                // 计算所有命名空间的配置总数
                let totalConfigs = 0;
                if (namespaces.code === 200 && namespaces.data) {
                    for (const ns of namespaces.data) {
                        try {
                            const configsResponse = await fetch(`/nacos/v1/cs/configs/list?namespace=${ns.namespace}`);
                            const configs = await configsResponse.json();
                            if (configs.code === 200 && configs.data) {
                                totalConfigs += configs.data.length;
                            }
                        } catch (error) {
                            console.error(`Error loading configs for namespace ${ns.namespace}:`, error);
                        }
                    }
                }
                
                // 更新统计数据
                document.getElementById('totalServices').textContent = 
                    services.code === 200 ? services.data.length : 0;
                document.getElementById('totalInstances').textContent = 
                    instances.code === 200 ? instances.data.length : 0;
                document.getElementById('totalConfigs').textContent = totalConfigs;
                document.getElementById('totalNamespaces').textContent = 
                    namespaces.code === 200 ? namespaces.data.length : 0;
                
                // 更新最近服务
                updateRecentServices(services.code === 200 ? services.data : []);
                
                // 更新最后更新时间
                updateLastUpdateTime();
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                document.getElementById('totalServices').textContent = '0';
                document.getElementById('totalInstances').textContent = '0';
                document.getElementById('totalConfigs').textContent = '0';
                document.getElementById('totalNamespaces').textContent = '0';
                document.getElementById('systemStatus').innerHTML = '<i class="bi bi-exclamation-triangle"></i> 错误';
                document.getElementById('systemStatus').className = 'badge bg-danger';
            }
        }
        
        // 更新最近服务
        function updateRecentServices(services) {
            const container = document.getElementById('recentServices');
            
            if (services.length === 0) {
                container.innerHTML = '<div class="text-center text-muted p-3">暂无服务</div>';
                return;
            }
            
            // 只显示前5个服务
            const recentServices = services.slice(0, 5);
            let html = '';
            
            recentServices.forEach(service => {
                html += `
                    <div class="activity-item">
                        <div class="d-flex align-items-center">
                            <div class="activity-icon bg-primary text-white me-3">
                                <i class="bi bi-server"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-0">${service}</h6>
                                <small class="text-muted">服务</small>
                            </div>
                            <a href="/services.html" class="btn btn-sm btn-outline-primary">
                                查看
                            </a>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // 更新最后更新时间
        function updateLastUpdateTime() {
            const now = new Date();
            document.getElementById('lastUpdateTime').textContent = 
                `最后更新: ${now.toLocaleTimeString()}`;
        }
        
        // 更新运行时间
        function updateUptime() {
            const uptime = Date.now() - startTime;
            const seconds = Math.floor(uptime / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            let uptimeText = '';
            if (days > 0) {
                uptimeText = `${days}天 ${hours % 24}小时`;
            } else if (hours > 0) {
                uptimeText = `${hours}小时 ${minutes % 60}分钟`;
            } else if (minutes > 0) {
                uptimeText = `${minutes}分钟 ${seconds % 60}秒`;
            } else {
                uptimeText = `${seconds}秒`;
            }
            
            document.getElementById('uptime').textContent = uptimeText;
        }
        
        // 设置构建时间
        function setBuildTime() {
            const buildTime = new Date().toLocaleDateString();
            document.getElementById('buildTime').textContent = buildTime;
        }
        
        // 刷新仪表盘
        async function refreshDashboard() {
            // 显示加载状态
            document.getElementById('totalServices').innerHTML = '<div class="loading-spinner"></div>';
            document.getElementById('totalInstances').innerHTML = '<div class="loading-spinner"></div>';
            document.getElementById('totalConfigs').innerHTML = '<div class="loading-spinner"></div>';
            document.getElementById('totalNamespaces').innerHTML = '<div class="loading-spinner"></div>';
            
            // 重新加载数据
            await loadDashboardData();
        }
        
        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
            setBuildTime();
            updateUptime();
            
            // 每秒更新运行时间
            setInterval(updateUptime, 1000);
            
            // 每30秒刷新数据
            setInterval(loadDashboardData, 30000);
        });
    </script>
</body>
</html>