<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>配置管理 - Rustacos</title>
    <link rel="stylesheet" href="bootstrap.min.css">
    <style>
        /* 直接内联字体定义 */
        @font-face {
            font-display: block;
            font-family: "bootstrap-icons";
            src: url("/fonts/bootstrap-icons.woff2?2ab2cbbe07fcebb53bdaa7313bb290f2") format("woff2"),
                 url("/fonts/bootstrap-icons.woff?2ab2cbbe07fcebb53bdaa7313bb290f2") format("woff");
        }
        
        .bi::before,
        [class^="bi-"]::before,
        [class*=" bi-"]::before {
            display: inline-block;
            font-family: bootstrap-icons !important;
            font-style: normal;
            font-weight: normal !important;
            font-variant: normal;
            text-transform: none;
            line-height: 1;
            vertical-align: -.125em;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .bi-eye::before { content: "\f341"; }
        .bi-pencil::before { content: "\f4cb"; }
        .bi-trash::before { content: "\f5de"; }
        .bi-plus-circle::before { content: "\f4fa"; }
        .bi-server::before { content: "\f4a3"; }
        .bi-gear::before { content: "\f3e5"; }
        .bi-folder::before { content: "\f3b1"; }
        .bi-hdd-network::before { content: "\f4b6"; }
        .bi-speedometer2::before { content: "\f549"; }
        .bi-plus-lg::before { content: "\f2bb"; }
        .bi-x-lg::before { content: "\f659"; }
        .bi-file-earmark-code::before { content: "\f6f5"; }
        
        /* 确保图标正确显示 */
        .btn i.bi {
            font-size: 1em;
            line-height: 1;
        }
        
        /* 确保按钮有合适的内边距 */
        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
        }
        
        /* 确保图标在按钮中垂直居中 */
        .btn i {
            vertical-align: middle;
        }
        
        /* 页面布局 - 确保页脚固定在底部 */
        html, body {
            height: 100%;
        }
        
        body {
            display: flex;
            flex-direction: column;
        }
        
        .content-wrapper {
            flex: 1 0 auto;
        }
        
        footer {
            flex-shrink: 0;
        }
        
        /* 代码块样式 */
        .config-content {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 0.375rem;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 300px;
            overflow-y: auto;
        }
        
        /* 命名空间选择器样式 */
        .namespace-selector {
            min-width: 200px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="bi bi-hdd-network"></i> Rustacos
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">
                            <i class="bi bi-speedometer2"></i> 仪表盘
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/services.html">
                            <i class="bi bi-server"></i> 服务管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/configs.html">
                            <i class="bi bi-gear"></i> 配置管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/namespaces.html">
                            <i class="bi bi-folder"></i> 命名空间
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="content-wrapper">
        <div class="container mt-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="page-title mb-0">
                    <i class="bi bi-gear"></i> 配置管理
                </h2>
                <div class="d-flex align-items-center">
                    <select class="form-select me-3 namespace-selector" id="namespaceSelector" style="min-width: 200px;">
                        <option value="public">public</option>
                    </select>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createConfigModal" style="white-space: nowrap;">
                        <i class="bi bi-plus-lg"></i> 新增配置
                    </button>
                </div>
            </div>
            
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="configsTable">
                            <thead>
                                <tr>
                                    <th>数据ID</th>
                                    <th>分组</th>
                                    <th>命名空间</th>
                                    <th>更新时间</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="5" class="text-center">
                                        <div class="spinner-border" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 创建配置模态框 -->
    <div class="modal fade" id="createConfigModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">新增配置</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createConfigForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="dataId" class="form-label">数据ID <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="dataId" required 
                                           placeholder="例如: application.properties">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="group" class="form-label">分组</label>
                                    <input type="text" class="form-control" id="group" 
                                           value="DEFAULT_GROUP" placeholder="例如: DEFAULT_GROUP">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="namespace" class="form-label">命名空间</label>
                            <select class="form-select" id="namespace">
                                <option value="public">public</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="content" class="form-label">配置内容 <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="content" rows="10" required 
                                      placeholder="请输入配置内容，例如:&#10;server.port=8080&#10;database.url=jdbc:mysql://localhost:3306/mydb"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="createConfig()">创建</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 查看配置模态框 -->
    <div class="modal fade" id="viewConfigModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">查看配置</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>数据ID:</strong> <span id="viewDataId"></span>
                        </div>
                        <div class="col-md-6">
                            <strong>分组:</strong> <span id="viewGroup"></span>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>命名空间:</strong> <span id="viewNamespace"></span>
                        </div>
                        <div class="col-md-6">
                            <strong>更新时间:</strong> <span id="viewUpdateTime"></span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <strong>配置内容:</strong>
                        <div class="config-content mt-2" id="viewContent"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" id="editFromViewBtn">编辑</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑配置模态框 -->
    <div class="modal fade" id="editConfigModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">编辑配置</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editConfigForm">
                        <input type="hidden" id="editOriginalDataId">
                        <input type="hidden" id="editOriginalGroup">
                        <input type="hidden" id="editOriginalNamespace">
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editDataId" class="form-label">数据ID <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="editDataId" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editGroup" class="form-label">分组</label>
                                    <input type="text" class="form-control" id="editGroup">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editNamespace" class="form-label">命名空间</label>
                            <select class="form-select" id="editNamespace">
                                <option value="public">public</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editContent" class="form-label">配置内容 <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="editContent" rows="10" required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="updateConfig()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-dark text-white text-center py-3">
        <div class="container">
            <p class="mb-0">© 2024 Rustacos - Nacos的Rust实现</p>
            <small class="text-muted">使用原生JavaScript构建的现代Web界面</small>
        </div>
    </footer>

    <script src="bootstrap.bundle.min.js"></script>
    <script>
        let currentNamespace = 'public';
        let namespaces = [];
        
        // 加载命名空间列表
        async function loadNamespaces() {
            try {
                const response = await fetch('/nacos/v1/console/namespaces');
                const result = await response.json();
                
                if (result.code === 200 && result.data) {
                    namespaces = result.data;
                    
                    // 更新命名空间选择器
                    const selectors = [
                        document.getElementById('namespaceSelector'),
                        document.getElementById('namespace'),
                        document.getElementById('editNamespace')
                    ];
                    
                    selectors.forEach(selector => {
                        if (selector) {
                            selector.innerHTML = '';
                            namespaces.forEach(ns => {
                                const option = document.createElement('option');
                                option.value = ns.namespace;
                                option.textContent = `${ns.namespace} - ${ns.namespace_show_name}`;
                                selector.appendChild(option);
                            });
                            selector.value = currentNamespace;
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading namespaces:', error);
            }
        }
        
        // 加载配置数据
        async function loadConfigs() {
            try {
                const response = await fetch(`/nacos/v1/cs/configs/list?namespace=${currentNamespace}`);
                const result = await response.json();
                
                const tbody = document.querySelector('#configsTable tbody');
                tbody.innerHTML = '';
                
                if (result.code === 200 && result.data) {
                    if (result.data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="text-center">暂无配置</td></tr>';
                        return;
                    }
                    
                    result.data.forEach(config => {
                        const tr = document.createElement('tr');
                        const updateTime = new Date(config.update_time).toLocaleString();
                        
                        tr.innerHTML = `
                            <td><code>${config.data_id}</code></td>
                            <td>${config.group}</td>
                            <td>${config.namespace}</td>
                            <td>${updateTime}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary me-1" onclick="viewConfig('${config.data_id}', '${config.group}', '${config.namespace}')" title="查看">
                                    <i class="bi bi-eye"></i> 查看
                                </button>
                                <button class="btn btn-sm btn-outline-secondary me-1" onclick="editConfigModal('${config.data_id}', '${config.group}', '${config.namespace}')" title="编辑">
                                    <i class="bi bi-pencil"></i> 编辑
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteConfig('${config.data_id}', '${config.group}', '${config.namespace}')" title="删除">
                                    <i class="bi bi-trash"></i> 删除
                                </button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center">加载失败</td></tr>';
                }
            } catch (error) {
                console.error('Error loading configs:', error);
                const tbody = document.querySelector('#configsTable tbody');
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">加载失败</td></tr>';
            }
        }
        
        // 创建配置
        async function createConfig() {
            const dataId = document.getElementById('dataId').value.trim();
            const group = document.getElementById('group').value.trim() || 'DEFAULT_GROUP';
            const namespace = document.getElementById('namespace').value;
            const content = document.getElementById('content').value.trim();
            
            if (!dataId || !content) {
                alert('请填写必填字段');
                return;
            }
            
            try {
                const response = await fetch('/nacos/v1/cs/configs', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        data_id: dataId,
                        group: group,
                        namespace: namespace,
                        content: content
                    })
                });
                
                const result = await response.json();
                
                if (result.code === 200 && result.data) {
                    // 关闭模态框
                    const modal = bootstrap.Modal.getInstance(document.getElementById('createConfigModal'));
                    modal.hide();
                    
                    // 清空表单
                    document.getElementById('createConfigForm').reset();
                    
                    // 重新加载数据
                    loadConfigs();
                    
                    alert('配置创建成功');
                } else {
                    alert('创建失败: ' + result.message);
                }
            } catch (error) {
                console.error('Error creating config:', error);
                alert('创建失败: 网络错误');
            }
        }
        
        // 查看配置
        async function viewConfig(dataId, group, namespace) {
            try {
                const response = await fetch(`/nacos/v1/cs/configs?data_id=${dataId}&group=${group}&namespace=${namespace}`);
                const result = await response.json();
                
                if (result.code === 200 && result.data) {
                    const config = result.data;
                    
                    document.getElementById('viewDataId').textContent = config.data_id;
                    document.getElementById('viewGroup').textContent = config.group;
                    document.getElementById('viewNamespace').textContent = config.namespace;
                    document.getElementById('viewUpdateTime').textContent = new Date(config.update_time).toLocaleString();
                    document.getElementById('viewContent').textContent = config.content;
                    
                    // 设置编辑按钮
                    document.getElementById('editFromViewBtn').onclick = () => {
                        const viewModal = bootstrap.Modal.getInstance(document.getElementById('viewConfigModal'));
                        viewModal.hide();
                        editConfigModal(dataId, group, namespace);
                    };
                    
                    // 显示模态框
                    const modal = new bootstrap.Modal(document.getElementById('viewConfigModal'));
                    modal.show();
                } else {
                    alert('配置不存在');
                }
            } catch (error) {
                console.error('Error viewing config:', error);
                alert('查看失败: 网络错误');
            }
        }
        
        // 打开编辑模态框
        async function editConfigModal(dataId, group, namespace) {
            try {
                const response = await fetch(`/nacos/v1/cs/configs?data_id=${dataId}&group=${group}&namespace=${namespace}`);
                const result = await response.json();
                
                if (result.code === 200 && result.data) {
                    const config = result.data;
                    
                    document.getElementById('editOriginalDataId').value = config.data_id;
                    document.getElementById('editOriginalGroup').value = config.group;
                    document.getElementById('editOriginalNamespace').value = config.namespace;
                    document.getElementById('editDataId').value = config.data_id;
                    document.getElementById('editGroup').value = config.group;
                    document.getElementById('editNamespace').value = config.namespace;
                    document.getElementById('editContent').value = config.content;
                    
                    // 显示模态框
                    const modal = new bootstrap.Modal(document.getElementById('editConfigModal'));
                    modal.show();
                } else {
                    alert('配置不存在');
                }
            } catch (error) {
                console.error('Error loading config for edit:', error);
                alert('加载失败: 网络错误');
            }
        }
        
        // 更新配置
        async function updateConfig() {
            const originalDataId = document.getElementById('editOriginalDataId').value;
            const originalGroup = document.getElementById('editOriginalGroup').value;
            const originalNamespace = document.getElementById('editOriginalNamespace').value;
            
            const dataId = document.getElementById('editDataId').value.trim();
            const group = document.getElementById('editGroup').value.trim() || 'DEFAULT_GROUP';
            const namespace = document.getElementById('editNamespace').value;
            const content = document.getElementById('editContent').value.trim();
            
            if (!dataId || !content) {
                alert('请填写必填字段');
                return;
            }
            
            try {
                // 先删除旧配置
                await fetch(`/nacos/v1/cs/configs?data_id=${originalDataId}&group=${originalGroup}&namespace=${originalNamespace}`, {
                    method: 'DELETE'
                });
                
                // 再创建新配置
                const response = await fetch('/nacos/v1/cs/configs', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        data_id: dataId,
                        group: group,
                        namespace: namespace,
                        content: content
                    })
                });
                
                const result = await response.json();
                
                if (result.code === 200 && result.data) {
                    // 关闭模态框
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editConfigModal'));
                    modal.hide();
                    
                    // 重新加载数据
                    loadConfigs();
                    
                    alert('配置更新成功');
                } else {
                    alert('更新失败: ' + result.message);
                }
            } catch (error) {
                console.error('Error updating config:', error);
                alert('更新失败: 网络错误');
            }
        }
        
        // 删除配置
        async function deleteConfig(dataId, group, namespace) {
            if (!confirm(`确定要删除配置 "${dataId}" 吗？`)) {
                return;
            }
            
            try {
                const response = await fetch(`/nacos/v1/cs/configs?data_id=${dataId}&group=${group}&namespace=${namespace}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.code === 200 && result.data) {
                    // 重新加载数据
                    loadConfigs();
                    
                    alert('配置删除成功');
                } else {
                    alert('删除失败: ' + result.message);
                }
            } catch (error) {
                console.error('Error deleting config:', error);
                alert('删除失败: 网络错误');
            }
        }
        
        // 命名空间选择器变化事件
        document.getElementById('namespaceSelector').addEventListener('change', function(e) {
            currentNamespace = e.target.value;
            loadConfigs();
        });
        
        // 页面加载时加载数据
        document.addEventListener('DOMContentLoaded', function() {
            loadNamespaces();
            loadConfigs();
        });
    </script>
</body>
</html>