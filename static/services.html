<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>服务管理 - Rustacos</title>
    <link rel="stylesheet" href="bootstrap.min.css">
    <style>
        /* 直接内联字体定义 */
        @font-face {
            font-display: block;
            font-family: "bootstrap-icons";
            src: url("/fonts/bootstrap-icons.woff2?2ab2cbbe07fcebb53bdaa7313bb290f2") format("woff2"),
                 url("/fonts/bootstrap-icons.woff?2ab2cbbe07fcebb53bdaa7313bb290f2") format("woff");
        }
        
        .bi::before,
        [class^="bi-"]::before,
        [class*=" bi-"]::before {
            display: inline-block;
            font-family: bootstrap-icons !important;
            font-style: normal;
            font-weight: normal !important;
            font-variant: normal;
            text-transform: none;
            line-height: 1;
            vertical-align: -.125em;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .bi-eye::before { content: "\f341"; }
        .bi-pencil::before { content: "\f4cb"; }
        .bi-trash::before { content: "\f5de"; }
        .bi-plus-circle::before { content: "\f4fa"; }
        .bi-server::before { content: "\f4a3"; }
        .bi-gear::before { content: "\f3e5"; }
        .bi-folder::before { content: "\f3b1"; }
        .bi-hdd-network::before { content: "\f4b6"; }
        .bi-speedometer2::before { content: "\f549"; }
        .bi-plus-lg::before { content: "\f2bb"; }
        .bi-x-lg::before { content: "\f659"; }
        .bi-heart-pulse::before { content: "\f21f"; }
        .bi-heart-pulse-fill::before { content: "\f21e"; }
        .bi-activity::before { content: "\f541"; }
        
        /* 确保图标正确显示 */
        .btn i.bi {
            font-size: 1em;
            line-height: 1;
        }
        
        /* 确保按钮有合适的内边距 */
        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
        }
        
        /* 确保图标在按钮中垂直居中 */
        .btn i {
            vertical-align: middle;
        }
        
        /* 页面布局 - 确保页脚固定在底部 */
        html, body {
            height: 100%;
        }
        
        body {
            display: flex;
            flex-direction: column;
        }
        
        .content-wrapper {
            flex: 1 0 auto;
        }
        
        footer {
            flex-shrink: 0;
        }
        
        /* 页面标题样式 */
        .page-title {
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 1rem;
            margin-bottom: 2rem;
        }
        
        /* 健康状态样式 */
        .health-status {
            font-size: 1.2em;
        }
        
        .health-healthy {
            color: #198754;
        }
        
        .health-unhealthy {
            color: #dc3545;
        }
        
        /* 实例详情卡片 */
        .instance-card {
            border-left: 4px solid #0d6efd;
            margin-bottom: 1rem;
            transition: transform 0.2s;
        }
        
        .instance-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .instance-card.healthy {
            border-left-color: #198754;
        }
        
        .instance-card.unhealthy {
            border-left-color: #dc3545;
        }
        
        /* 服务列表项样式 */
        .service-item {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .service-item:hover {
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="bi bi-hdd-network"></i> Rustacos
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">
                            <i class="bi bi-speedometer2"></i> 仪表盘
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/services.html">
                            <i class="bi bi-server"></i> 服务管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/configs.html">
                            <i class="bi bi-gear"></i> 配置管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/namespaces.html">
                            <i class="bi bi-folder"></i> 命名空间
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="content-wrapper">
        <div class="container mt-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="page-title mb-0">
                    <i class="bi bi-server"></i> 服务管理
                </h2>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#registerInstanceModal" style="white-space: nowrap;">
                    <i class="bi bi-plus-lg"></i> 注册实例
                </button>
            </div>
            
            <div class="row">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">服务列表</h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="list-group list-group-flush" id="servicesList">
                                <div class="text-center p-3">
                                    <div class="spinner-border spinner-border-sm" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0" id="serviceDetailTitle">选择服务查看详情</h5>
                            <button class="btn btn-sm btn-outline-secondary" id="refreshServiceBtn" onclick="refreshCurrentService()">
                                <i class="bi bi-arrow-clockwise"></i> 刷新
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="serviceDetailContent">
                                <div class="text-center text-muted p-5">
                                    <i class="bi bi-server" style="font-size: 3rem;"></i>
                                    <p class="mt-3">请从左侧选择一个服务查看详情</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 注册实例模态框 -->
    <div class="modal fade" id="registerInstanceModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">注册服务实例</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="registerInstanceForm">
                        <div class="mb-3">
                            <label for="serviceName" class="form-label">服务名 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="serviceName" required 
                                   placeholder="例如: user-service">
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="instanceIp" class="form-label">IP地址 <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="instanceIp" required 
                                           placeholder="例如: 127.0.0.1" pattern="^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="instancePort" class="form-label">端口 <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" id="instancePort" required 
                                           placeholder="例如: 8080" min="1" max="65535">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="groupName" class="form-label">分组名</label>
                                    <input type="text" class="form-control" id="groupName" 
                                           value="DEFAULT_GROUP" placeholder="例如: DEFAULT_GROUP">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="clusterName" class="form-label">集群名</label>
                                    <input type="text" class="form-control" id="clusterName" 
                                           value="DEFAULT" placeholder="例如: DEFAULT">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="weight" class="form-label">权重</label>
                            <input type="number" class="form-control" id="weight" 
                                   value="1" min="0" max="100" step="0.1">
                            <div class="form-text">用于负载均衡的权重值（0-100）</div>
                        </div>
                        <div class="mb-3">
                            <label for="metadata" class="form-label">元数据</label>
                            <textarea class="form-control" id="metadata" rows="3" 
                                      placeholder='JSON格式，例如:&#10;{"version": "1.0.0", "env": "prod"}'></textarea>
                            <div class="form-text">可选的键值对元数据，JSON格式</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="registerInstance()">注册</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 实例详情模态框 -->
    <div class="modal fade" id="instanceDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">实例详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="instanceDetailContent">
                    <!-- 动态填充 -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-danger" id="deregisterInstanceBtn">注销实例</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-dark text-white text-center py-3">
        <div class="container">
            <p class="mb-0">© 2024 Rustacos - Nacos的Rust实现</p>
            <small class="text-muted">使用原生JavaScript构建的现代Web界面</small>
        </div>
    </footer>

    <script src="bootstrap.bundle.min.js"></script>
    <script>
        let services = [];
        let currentService = null;
        let currentInstances = [];
        
        // 加载服务列表
        async function loadServices() {
            try {
                const response = await fetch('/nacos/v1/ns/service/list');
                const result = await response.json();
                
                const servicesList = document.getElementById('servicesList');
                
                if (result.code === 200 && result.data) {
                    services = result.data;
                    
                    if (services.length === 0) {
                        servicesList.innerHTML = '<div class="text-center p-3 text-muted">暂无服务</div>';
                        return;
                    }
                    
                    servicesList.innerHTML = '';
                    services.forEach(service => {
                        const item = document.createElement('a');
                        item.href = '#';
                        item.className = 'list-group-item list-group-item-action service-item';
                        item.innerHTML = `
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">${service}</h6>
                                <small class="text-muted">点击查看详情</small>
                            </div>
                        `;
                        item.onclick = (e) => {
                            e.preventDefault();
                            selectService(service);
                        };
                        servicesList.appendChild(item);
                    });
                    
                    // 如果有服务，默认选择第一个
                    if (services.length > 0 && !currentService) {
                        selectService(services[0]);
                    }
                } else {
                    servicesList.innerHTML = '<div class="text-center p-3 text-danger">加载失败</div>';
                }
            } catch (error) {
                console.error('Error loading services:', error);
                const servicesList = document.getElementById('servicesList');
                servicesList.innerHTML = '<div class="text-center p-3 text-danger">加载失败</div>';
            }
        }
        
        // 选择服务
        async function selectService(serviceName) {
            currentService = serviceName;
            
            // 更新选中状态
            document.querySelectorAll('.service-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.service-item').classList.add('active');
            
            // 更新标题
            document.getElementById('serviceDetailTitle').textContent = serviceName;
            
            // 加载实例详情
            await loadServiceInstances(serviceName);
        }
        
        // 加载服务实例
        async function loadServiceInstances(serviceName) {
            try {
                const response = await fetch(`/nacos/v1/ns/instance/list?service_name=${serviceName}`);
                const result = await response.json();
                
                const detailContent = document.getElementById('serviceDetailContent');
                
                if (result.code === 200 && result.data) {
                    currentInstances = result.data;
                    
                    if (currentInstances.length === 0) {
                        detailContent.innerHTML = `
                            <div class="text-center text-muted p-5">
                                <i class="bi bi-server" style="font-size: 3rem;"></i>
                                <p class="mt-3">该服务暂无实例</p>
                                <button class="btn btn-primary" onclick="showRegisterModal('${serviceName}')">
                                    <i class="bi bi-plus-lg"></i> 注册实例
                                </button>
                            </div>
                        `;
                        return;
                    }
                    
                    let html = `
                        <div class="mb-3">
                            <span class="badge bg-primary">实例总数: ${currentInstances.length}</span>
                            <span class="badge bg-success ms-2">健康实例: ${currentInstances.filter(i => i.healthy).length}</span>
                            <span class="badge bg-danger ms-2">不健康实例: ${currentInstances.filter(i => !i.healthy).length}</span>
                        </div>
                    `;
                    
                    currentInstances.forEach(instance => {
                        const healthClass = instance.healthy ? 'healthy' : 'unhealthy';
                        const healthIcon = instance.healthy ? 'heart-pulse-fill' : 'heart-pulse';
                        const healthText = instance.healthy ? '健康' : '不健康';
                        const healthColor = instance.healthy ? 'text-success' : 'text-danger';
                        
                        html += `
                            <div class="card instance-card ${healthClass}" onclick="showInstanceDetail('${instance.id}')">
                                <div class="card-body">
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <h6 class="card-title mb-1">
                                                ${instance.ip}:${instance.port}
                                                <i class="bi bi-${healthIcon} ${healthColor} health-status ms-2"></i>
                                            </h6>
                                            <p class="card-text">
                                                <small class="text-muted">
                                                    分组: ${instance.group_name} | 集群: ${instance.cluster_name} | 权重: ${instance.weight}
                                                </small>
                                            </p>
                                        </div>
                                        <div class="col-md-4 text-end">
                                            <span class="badge ${instance.healthy ? 'bg-success' : 'bg-danger'}">${healthText}</span>
                                            <div class="mt-2">
                                                <button class="btn btn-sm btn-outline-primary me-1" onclick="event.stopPropagation(); showInstanceDetail('${instance.id}')">
                                                    <i class="bi bi-eye"></i> 详情
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); deregisterInstance('${instance.id}')" 
                                                        ${instance.healthy ? '' : 'disabled'}>
                                                    <i class="bi bi-trash"></i> 注销
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    detailContent.innerHTML = html;
                } else {
                    detailContent.innerHTML = '<div class="text-center text-danger">加载失败</div>';
                }
            } catch (error) {
                console.error('Error loading instances:', error);
                const detailContent = document.getElementById('serviceDetailContent');
                detailContent.innerHTML = '<div class="text-center text-danger">加载失败</div>';
            }
        }
        
        // 刷新当前服务
        async function refreshCurrentService() {
            if (currentService) {
                await loadServiceInstances(currentService);
            }
        }
        
        // 显示注册模态框
        function showRegisterModal(serviceName) {
            if (serviceName) {
                document.getElementById('serviceName').value = serviceName;
            }
            const modal = new bootstrap.Modal(document.getElementById('registerInstanceModal'));
            modal.show();
        }
        
        // 注册实例
        async function registerInstance() {
            const serviceName = document.getElementById('serviceName').value.trim();
            const ip = document.getElementById('instanceIp').value.trim();
            const port = parseInt(document.getElementById('instancePort').value);
            const groupName = document.getElementById('groupName').value.trim() || 'DEFAULT_GROUP';
            const clusterName = document.getElementById('clusterName').value.trim() || 'DEFAULT';
            const weight = parseFloat(document.getElementById('weight').value) || 1.0;
            let metadata = {};
            
            const metadataText = document.getElementById('metadata').value.trim();
            if (metadataText) {
                try {
                    metadata = JSON.parse(metadataText);
                } catch (e) {
                    alert('元数据格式错误，请输入有效的JSON');
                    return;
                }
            }
            
            if (!serviceName || !ip || !port) {
                alert('请填写必填字段');
                return;
            }
            
            try {
                const response = await fetch('/nacos/v1/ns/instance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        service_name: serviceName,
                        ip: ip,
                        port: port,
                        group_name: groupName,
                        cluster_name: clusterName,
                        weight: weight,
                        metadata: metadata
                    })
                });
                
                const result = await response.json();
                
                if (result.code === 200 && result.data) {
                    // 关闭模态框
                    const modal = bootstrap.Modal.getInstance(document.getElementById('registerInstanceModal'));
                    modal.hide();
                    
                    // 清空表单
                    document.getElementById('registerInstanceForm').reset();
                    
                    // 重新加载数据
                    await loadServices();
                    
                    alert('实例注册成功');
                } else {
                    alert('注册失败: ' + result.message);
                }
            } catch (error) {
                console.error('Error registering instance:', error);
                alert('注册失败: 网络错误');
            }
        }
        
        // 显示实例详情
        function showInstanceDetail(instanceId) {
            const instance = currentInstances.find(i => i.id === instanceId);
            if (!instance) return;
            
            const metadata = Object.keys(instance.metadata).length > 0 
                ? JSON.stringify(instance.metadata, null, 2) 
                : '无';
            
            const content = `
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <td><strong>实例ID:</strong></td>
                                <td><code>${instance.id}</code></td>
                            </tr>
                            <tr>
                                <td><strong>IP地址:</strong></td>
                                <td>${instance.ip}</td>
                            </tr>
                            <tr>
                                <td><strong>端口:</strong></td>
                                <td>${instance.port}</td>
                            </tr>
                            <tr>
                                <td><strong>服务名:</strong></td>
                                <td>${instance.service_name}</td>
                            </tr>
                            <tr>
                                <td><strong>分组名:</strong></td>
                                <td>${instance.group_name}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <td><strong>集群名:</strong></td>
                                <td>${instance.cluster_name}</td>
                            </tr>
                            <tr>
                                <td><strong>权重:</strong></td>
                                <td>${instance.weight}</td>
                            </tr>
                            <tr>
                                <td><strong>健康状态:</strong></td>
                                <td>
                                    <span class="badge ${instance.healthy ? 'bg-success' : 'bg-danger'}">
                                        ${instance.healthy ? '健康' : '不健康'}
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <td><strong>最后心跳:</strong></td>
                                <td>${new Date(instance.last_beat_time).toLocaleString()}</td>
                            </tr>
                        </table>
                    </div>
                </div>
                <div class="mt-3">
                    <strong>元数据:</strong>
                    <pre class="bg-light p-3 mt-2 rounded">${metadata}</pre>
                </div>
            `;
            
            document.getElementById('instanceDetailContent').innerHTML = content;
            document.getElementById('deregisterInstanceBtn').onclick = () => {
                const detailModal = bootstrap.Modal.getInstance(document.getElementById('instanceDetailModal'));
                detailModal.hide();
                deregisterInstance(instanceId);
            };
            
            const modal = new bootstrap.Modal(document.getElementById('instanceDetailModal'));
            modal.show();
        }
        
        // 注销实例
        async function deregisterInstance(instanceId) {
            if (!confirm('确定要注销这个实例吗？')) {
                return;
            }
            
            try {
                const response = await fetch(`/nacos/v1/ns/instance/${currentService}/${instanceId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.code === 200) {
                    // 重新加载数据
                    await loadServices();
                    
                    alert('实例注销成功');
                } else {
                    alert('注销失败: ' + result.message);
                }
            } catch (error) {
                console.error('Error deregistering instance:', error);
                alert('注销失败: 网络错误');
            }
        }
        
        // 页面加载时加载数据
        document.addEventListener('DOMContentLoaded', loadServices);
        
        // 每30秒刷新一次数据
        setInterval(() => {
            loadServices();
            if (currentService) {
                loadServiceInstances(currentService);
            }
        }, 30000);
    </script>
</body>
</html>